<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>redisTemplate执行lua脚本抛出IllegalStateException异常 | 南极阳光</title>

<meta name="keywords" content="Redis" />
<meta name="description" content="1. 问题描述 在项目中，实现延迟队列的过程中，需要实现一个分布式锁，由于项目已经使用了Redis，就打算基于Redis实现一个简单的分布式锁。对">
<meta name="author" content="Me">
<link rel="canonical" href="https://jiayanju.github.io/post/redistemplate%E6%89%A7%E8%A1%8Clua%E8%84%9A%E6%9C%AC%E6%8A%9B%E5%87%BAillegalstateexception%E5%BC%82%E5%B8%B8/" />
<link href="/assets/css/stylesheet.min.4f1ad98d0bbc51ea2c950f063c7e29522bc8945c9dd06348318cd4cce6be44bb.css" integrity="sha256-TxrZjQu8UeoslQ8GPH4pUivIlFyd0GNIMYzUzOa&#43;RLs=" rel="preload stylesheet"
    as="style">

<link rel="icon" href="https://jiayanju.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://jiayanju.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://jiayanju.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://jiayanju.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://jiayanju.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.80.0" />


<meta property="og:title" content="redisTemplate执行lua脚本抛出IllegalStateException异常" />
<meta property="og:description" content="1. 问题描述 在项目中，实现延迟队列的过程中，需要实现一个分布式锁，由于项目已经使用了Redis，就打算基于Redis实现一个简单的分布式锁。对" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jiayanju.github.io/post/redistemplate%E6%89%A7%E8%A1%8Clua%E8%84%9A%E6%9C%AC%E6%8A%9B%E5%87%BAillegalstateexception%E5%BC%82%E5%B8%B8/" />
<meta property="og:image" content="https://raw.githubusercontent.com/jiayanju/imgrepo/main/floor1.jpg" /><meta property="article:published_time" content="2021-02-20T22:30:00+08:00" />
<meta property="article:modified_time" content="2021-02-20T22:30:00+08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://raw.githubusercontent.com/jiayanju/imgrepo/main/floor1.jpg" />
<meta name="twitter:title" content="redisTemplate执行lua脚本抛出IllegalStateException异常"/>
<meta name="twitter:description" content="1. 问题描述 在项目中，实现延迟队列的过程中，需要实现一个分布式锁，由于项目已经使用了Redis，就打算基于Redis实现一个简单的分布式锁。对"/>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "redisTemplate执行lua脚本抛出IllegalStateException异常",
  "name": "redisTemplate执行lua脚本抛出IllegalStateException异常",
  "description": "1. 问题描述 在项目中，实现延迟队列的过程中，需要实现一个分布式锁，由于项目已经使用了Redis，就打算基于Redis实现一个简单的分布式锁。对",
  "keywords": [
    "Redis"
  ],
  "articleBody": "1. 问题描述 在项目中，实现延迟队列的过程中，需要实现一个分布式锁，由于项目已经使用了Redis，就打算基于Redis实现一个简单的分布式锁。对应分布式锁，在释放锁的时候需要使用lua脚本保证一下原子性，代码如下:\npublic boolean unlock(String uniqueId) { if (StringUtils.isEmpty(uniqueId)) { return false; } Long result = redisTemplate.execute(RedisScript.of(RELEASE_LOCK_LUA_SCRIPT), Collections.singletonList(getLockKey(lockKey)), uniqueId); if (Objects.equals(result, RELEASE_LOCK_SUCCESS_RESULT)) { return true; } return false; } 在运行的过程中抛出以下异常\nException in thread \"delay-queue-handler-task-2\" org.springframework.data.redis.RedisSystemException: Redis exception; nested exception is io.lettuce.core.RedisException: java.lang.IllegalStateException at org.springframework.data.redis.connection.lettuce.LettuceExceptionConverter.convert(LettuceExceptionConverter.java:74) at org.springframework.data.redis.connection.lettuce.LettuceExceptionConverter.convert(LettuceExceptionConverter.java:41) at org.springframework.data.redis.PassThroughExceptionTranslationStrategy.translate(PassThroughExceptionTranslationStrategy.java:44) at org.springframework.data.redis.FallbackExceptionTranslationStrategy.translate(FallbackExceptionTranslationStrategy.java:42) at org.springframework.data.redis.connection.lettuce.LettuceConnection.convertLettuceAccessException(LettuceConnection.java:268) at org.springframework.data.redis.connection.lettuce.LettuceScriptingCommands.convertLettuceAccessException(LettuceScriptingCommands.java:236) at org.springframework.data.redis.connection.lettuce.LettuceScriptingCommands.eval(LettuceScriptingCommands.java:163) at org.springframework.data.redis.connection.DefaultedRedisConnection.eval(DefaultedRedisConnection.java:1311) at org.springframework.data.redis.connection.DefaultStringRedisConnection.eval(DefaultStringRedisConnection.java:1720) at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) at java.lang.reflect.Method.invoke(Method.java:497) at org.springframework.data.redis.core.CloseSuppressingInvocationHandler.invoke(CloseSuppressingInvocationHandler.java:61) at com.sun.proxy.$Proxy414.eval(Unknown Source) at org.springframework.data.redis.core.script.DefaultScriptExecutor.eval(DefaultScriptExecutor.java:84) at org.springframework.data.redis.core.script.DefaultScriptExecutor.lambda$execute$0(DefaultScriptExecutor.java:68) at org.springframework.data.redis.core.RedisTemplate.execute(RedisTemplate.java:225) at org.springframework.data.redis.core.RedisTemplate.execute(RedisTemplate.java:185) at org.springframework.data.redis.core.RedisTemplate.execute(RedisTemplate.java:172) at org.springframework.data.redis.core.script.DefaultScriptExecutor.execute(DefaultScriptExecutor.java:58) at org.springframework.data.redis.core.script.DefaultScriptExecutor.execute(DefaultScriptExecutor.java:52) at org.springframework.data.redis.core.RedisTemplate.execute(RedisTemplate.java:347) at cn.udesk.ecology.common.component.lock.RedisDistributeLock.unlock(RedisDistributeLock.java:118) at cn.udesk.ecology.common.component.delayqueue.DelayQueueHandler.run(DelayQueueHandler.java:57) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) at java.lang.Thread.run(Thread.java:745) Caused by: io.lettuce.core.RedisException: java.lang.IllegalStateException at io.lettuce.core.LettuceFutures.awaitOrCancel(LettuceFutures.java:129) at io.lettuce.core.FutureSyncInvocationHandler.handleInvocation(FutureSyncInvocationHandler.java:69) at io.lettuce.core.internal.AbstractInvocationHandler.invoke(AbstractInvocationHandler.java:80) at com.sun.proxy.$Proxy413.eval(Unknown Source) at org.springframework.data.redis.connection.lettuce.LettuceScriptingCommands.eval(LettuceScriptingCommands.java:161) ... 21 more Caused by: java.lang.IllegalStateException at io.lettuce.core.output.CommandOutput.set(CommandOutput.java:85) at io.lettuce.core.protocol.RedisStateMachine.safeSet(RedisStateMachine.java:357) at io.lettuce.core.protocol.RedisStateMachine.decode(RedisStateMachine.java:138) at io.lettuce.core.protocol.CommandHandler.decode(CommandHandler.java:708) at io.lettuce.core.protocol.CommandHandler.decode0(CommandHandler.java:672) at io.lettuce.core.protocol.CommandHandler.decode(CommandHandler.java:658) at io.lettuce.core.protocol.CommandHandler.decode(CommandHandler.java:587) at io.lettuce.core.protocol.CommandHandler.channelRead(CommandHandler.java:556) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365) at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357) at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365) at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919) at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166) at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:714) at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:650) at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:576) at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:493) at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:989) at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) ... 1 more 2. 问题分析 查看异常堆栈信息，执行路径代码\norg.springframework.data.redis.core.script.DefaultScriptExecutor#execute(org.springframework.data.redis.core.script.RedisScript, org.springframework.data.redis.serializer.RedisSerializer, org.springframework.data.redis.serializer.RedisSerializer, java.util.List, java.lang.Object…)\npublic T T execute(final RedisScriptT script, final RedisSerializer argsSerializer, final RedisSerializerT resultSerializer, final ListK keys, final Object... args) { return template.execute((RedisCallbackT) connection - { final ReturnType returnType = ReturnType.fromJavaType(script.getResultType()); final byte[][] keysAndArgs = keysAndArgs(argsSerializer, keys, args); final int keySize = keys != null ? keys.size() : 0; if (connection.isPipelined() || connection.isQueueing()) { // We could script load first and then do evalsha to ensure sha is present, \t// but this adds a sha1 to exec/closePipeline results. Instead, just eval \tconnection.eval(scriptBytes(script), returnType, keySize, keysAndArgs); return null; } return eval(connection, script, returnType, keySize, keysAndArgs, resultSerializer); }); } org.springframework.data.redis.connection.ReturnType#fromJavaType\n/** * @param javaType can be {@literal null} which translates to {@link ReturnType#STATUS}. * @return never {@literal null}. */ public static ReturnType fromJavaType(@Nullable Class javaType) { if (javaType == null) { return ReturnType.STATUS; } if (javaType.isAssignableFrom(List.class)) { return ReturnType.MULTI; } if (javaType.isAssignableFrom(Boolean.class)) { return ReturnType.BOOLEAN; } if (javaType.isAssignableFrom(Long.class)) { return ReturnType.INTEGER; } return ReturnType.VALUE; } 有上面这个方法可以看出，如果传入的javaType为null，则ReturnType为STAUTS，如果是Long，则返回INTEGER\norg.springframework.data.redis.connection.lettuce.LettuceScriptingCommands#eval\npublic T T eval(byte[] script, ReturnType returnType, int numKeys, byte[]... keysAndArgs) { Assert.notNull(script, \"Script must not be null!\"); try { byte[][] keys = extractScriptKeys(numKeys, keysAndArgs); byte[][] args = extractScriptArgs(numKeys, keysAndArgs); String convertedScript = LettuceConverters.toString(script); if (isPipelined()) { pipeline(connection.newLettuceResult( getAsyncConnection().eval(convertedScript, LettuceConverters.toScriptOutputType(returnType), keys, args), new LettuceEvalResultsConverterT(returnType))); return null; } if (isQueueing()) { transaction(connection.newLettuceResult( getAsyncConnection().eval(convertedScript, LettuceConverters.toScriptOutputType(returnType), keys, args), new LettuceEvalResultsConverterT(returnType))); return null; } return new LettuceEvalResultsConverterT(returnType) .convert(getConnection().eval(convertedScript, LettuceConverters.toScriptOutputType(returnType), keys, args)); } catch (Exception ex) { throw convertLettuceAccessException(ex); } } 底层使用异步的命令方式\nio.lettuce.core.AbstractRedisAsyncCommands#eval(java.lang.String, io.lettuce.core.ScriptOutputType, K[], V…)\npublic T RedisFutureT eval(String script, ScriptOutputType type, K[] keys, V... values) { return (RedisFutureT) dispatch(commandBuilder.eval(script, type, keys, values)); } io.lettuce.core.RedisCommandBuilder#eval(java.lang.String, io.lettuce.core.ScriptOutputType, K…)\nT CommandK, V, T eval(String script, ScriptOutputType type, K... keys) { LettuceAssert.notNull(script, \"Script \" + MUST_NOT_BE_NULL); LettuceAssert.notEmpty(script, \"Script \" + MUST_NOT_BE_EMPTY); LettuceAssert.notNull(type, \"ScriptOutputType \" + MUST_NOT_BE_NULL); LettuceAssert.notNull(keys, \"Keys \" + MUST_NOT_BE_NULL); CommandArgsK, V args = new CommandArgs(codec); args.add(script.getBytes()).add(keys.length).addKeys(keys); CommandOutputK, V, T output = newScriptOutput(codec, type); return createCommand(EVAL, output, args); } 从上面可以看到CommandOutput的构造\nCommandOutputoutput = newScriptOutput(codec, type);\nprotected T CommandOutputK, V, T newScriptOutput(RedisCodecK, V codec, ScriptOutputType type) { switch (type) { case BOOLEAN: return (CommandOutputK, V, T) new BooleanOutputK, V(codec); case INTEGER: return (CommandOutputK, V, T) new IntegerOutputK, V(codec); case STATUS: return (CommandOutputK, V, T) new StatusOutputK, V(codec); case MULTI: return (CommandOutputK, V, T) new NestedMultiOutputK, V(codec); case VALUE: return (CommandOutputK, V, T) new ValueOutputK, V(codec); default: throw new RedisException(\"Unsupported script output type\"); } } STATUS时，返回StatusOutput对象\n看一下下面的异常信息\nCaused by: java.lang.IllegalStateException at io.lettuce.core.output.CommandOutput.set(CommandOutput.java:85) at io.lettuce.core.protocol.RedisStateMachine.safeSet(RedisStateMachine.java:357) at io.lettuce.core.protocol.RedisStateMachine.decode(RedisStateMachine.java:138) CommandOutput是个抽象类, set方法抛出异常\npublic void set(long integer) { throw new IllegalStateException(); } 而StatusOutput对象是CommandOutput的实现类单并没有实现set方法，因此抛出了异常。\n3. 问题解决 从上面的分析得出，应该使用IntegerOutput实现类，这个实现类对应的returnType是Long类型。所以应该对RedisScript设置resultType为Long.class.\npublic boolean unlock(String uniqueId) { if (StringUtils.isEmpty(uniqueId)) { return false; } DefaultRedisScriptLong script = new DefaultRedisScript(RELEASE_LOCK_LUA_SCRIPT, Long.class); Long result = redisTemplate.execute(script, Collections.singletonList(getLockKey(lockKey)), uniqueId); if (Objects.equals(result, RELEASE_LOCK_SUCCESS_RESULT)) { return true; } return false; } 至此，问题解决~\n",
  "wordCount" : "1066",
  "inLanguage": "en",
  "image":"https://raw.githubusercontent.com/jiayanju/imgrepo/main/floor1.jpg","datePublished": "2021-02-20T22:30:00+08:00",
  "dateModified": "2021-02-20T22:30:00+08:00",
  "author":{
    "@type": "Person",
    "name": "Me"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://jiayanju.github.io/post/redistemplate%E6%89%A7%E8%A1%8Clua%E8%84%9A%E6%9C%AC%E6%8A%9B%E5%87%BAillegalstateexception%E5%BC%82%E5%B8%B8/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "南极阳光",
    "logo": {
      "@type": "ImageObject",
      "url": "https://jiayanju.github.io/favicon.ico"
    }
  }
}
</script>



</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        .theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://jiayanju.github.io" accesskey="h" title="南极阳光 (Alt + H)">南极阳光</a>
            <span class="logo-switches">
                <span class="theme-toggle" title="(Alt + T)">
                    <a id="theme-toggle" accesskey="t">
                        <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                        <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                    </a>
                </span>
                
            </span>
        </div>
        <ul class="menu" id="menu" onscroll="menu_on_scroll()">
            <li>
                <a href="https://jiayanju.github.io/posts" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://jiayanju.github.io/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://jiayanju.github.io/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://jiayanju.github.io/about" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://jiayanju.github.io/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li></ul>
    </nav>
</header>

    <main class="main">

<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">
      redisTemplate执行lua脚本抛出IllegalStateException异常
    </h1>
    <div class="post-description">
      
    </div>
    <div class="post-meta">

February 20, 2021&nbsp;·&nbsp;Me

    </div>
  </header> 
<figure class="entry-cover"><img src="https://raw.githubusercontent.com/jiayanju/imgrepo/main/floor1.jpg" alt="">
        
</figure>

  <div class="toc">
    <details >
      <summary accesskey="c" title="(Alt + C)">
        <div class="details">Table of Contents</div>
      </summary>
      <div class="inner"><ul><li>
        <a href="#1-%e9%97%ae%e9%a2%98%e6%8f%8f%e8%bf%b0" aria-label="1. 问题描述">1. 问题描述</a></li><li>
        <a href="#2-%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90" aria-label="2. 问题分析">2. 问题分析</a></li><li>
        <a href="#3-%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3" aria-label="3. 问题解决">3. 问题解决</a></li></ul>
      </div>
    </details>
  </div>
  <div class="post-content">
<h2 id="1-问题描述">1. 问题描述<a hidden class="anchor" aria-hidden="true" href="#1-问题描述">#</a></h2>
<p>在项目中，实现延迟队列的过程中，需要实现一个分布式锁，由于项目已经使用了Redis，就打算基于Redis实现一个简单的分布式锁。对应分布式锁，在释放锁的时候需要使用lua脚本保证一下原子性，代码如下:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">unlock</span><span style="color:#f92672">(</span>String uniqueId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">(</span>uniqueId<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    Long result <span style="color:#f92672">=</span> redisTemplate<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span>RedisScript<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span>RELEASE_LOCK_LUA_SCRIPT<span style="color:#f92672">),</span> Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">singletonList</span><span style="color:#f92672">(</span>getLockKey<span style="color:#f92672">(</span>lockKey<span style="color:#f92672">)),</span> uniqueId<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Objects<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>result<span style="color:#f92672">,</span> RELEASE_LOCK_SUCCESS_RESULT<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
</code></pre></div><p>在运行的过程中抛出以下异常</p>
<pre><code>Exception in thread &quot;delay-queue-handler-task-2&quot; org.springframework.data.redis.RedisSystemException: Redis exception; nested exception is io.lettuce.core.RedisException: java.lang.IllegalStateException
	at org.springframework.data.redis.connection.lettuce.LettuceExceptionConverter.convert(LettuceExceptionConverter.java:74)
	at org.springframework.data.redis.connection.lettuce.LettuceExceptionConverter.convert(LettuceExceptionConverter.java:41)
	at org.springframework.data.redis.PassThroughExceptionTranslationStrategy.translate(PassThroughExceptionTranslationStrategy.java:44)
	at org.springframework.data.redis.FallbackExceptionTranslationStrategy.translate(FallbackExceptionTranslationStrategy.java:42)
	at org.springframework.data.redis.connection.lettuce.LettuceConnection.convertLettuceAccessException(LettuceConnection.java:268)
	at org.springframework.data.redis.connection.lettuce.LettuceScriptingCommands.convertLettuceAccessException(LettuceScriptingCommands.java:236)
	at org.springframework.data.redis.connection.lettuce.LettuceScriptingCommands.eval(LettuceScriptingCommands.java:163)
	at org.springframework.data.redis.connection.DefaultedRedisConnection.eval(DefaultedRedisConnection.java:1311)
	at org.springframework.data.redis.connection.DefaultStringRedisConnection.eval(DefaultStringRedisConnection.java:1720)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:497)
	at org.springframework.data.redis.core.CloseSuppressingInvocationHandler.invoke(CloseSuppressingInvocationHandler.java:61)
	at com.sun.proxy.$Proxy414.eval(Unknown Source)
	at org.springframework.data.redis.core.script.DefaultScriptExecutor.eval(DefaultScriptExecutor.java:84)
	at org.springframework.data.redis.core.script.DefaultScriptExecutor.lambda$execute$0(DefaultScriptExecutor.java:68)
	at org.springframework.data.redis.core.RedisTemplate.execute(RedisTemplate.java:225)
	at org.springframework.data.redis.core.RedisTemplate.execute(RedisTemplate.java:185)
	at org.springframework.data.redis.core.RedisTemplate.execute(RedisTemplate.java:172)
	at org.springframework.data.redis.core.script.DefaultScriptExecutor.execute(DefaultScriptExecutor.java:58)
	at org.springframework.data.redis.core.script.DefaultScriptExecutor.execute(DefaultScriptExecutor.java:52)
	at org.springframework.data.redis.core.RedisTemplate.execute(RedisTemplate.java:347)
	at cn.udesk.ecology.common.component.lock.RedisDistributeLock.unlock(RedisDistributeLock.java:118)
	at cn.udesk.ecology.common.component.delayqueue.DelayQueueHandler.run(DelayQueueHandler.java:57)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
Caused by: io.lettuce.core.RedisException: java.lang.IllegalStateException
	at io.lettuce.core.LettuceFutures.awaitOrCancel(LettuceFutures.java:129)
	at io.lettuce.core.FutureSyncInvocationHandler.handleInvocation(FutureSyncInvocationHandler.java:69)
	at io.lettuce.core.internal.AbstractInvocationHandler.invoke(AbstractInvocationHandler.java:80)
	at com.sun.proxy.$Proxy413.eval(Unknown Source)
	at org.springframework.data.redis.connection.lettuce.LettuceScriptingCommands.eval(LettuceScriptingCommands.java:161)
	... 21 more
Caused by: java.lang.IllegalStateException
	at io.lettuce.core.output.CommandOutput.set(CommandOutput.java:85)
	at io.lettuce.core.protocol.RedisStateMachine.safeSet(RedisStateMachine.java:357)
	at io.lettuce.core.protocol.RedisStateMachine.decode(RedisStateMachine.java:138)
	at io.lettuce.core.protocol.CommandHandler.decode(CommandHandler.java:708)
	at io.lettuce.core.protocol.CommandHandler.decode0(CommandHandler.java:672)
	at io.lettuce.core.protocol.CommandHandler.decode(CommandHandler.java:658)
	at io.lettuce.core.protocol.CommandHandler.decode(CommandHandler.java:587)
	at io.lettuce.core.protocol.CommandHandler.channelRead(CommandHandler.java:556)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)
	at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)
	at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)
	at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919)
	at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166)
	at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:714)
	at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:650)
	at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:576)
	at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:493)
	at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:989)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	... 1 more
</code></pre><h2 id="2-问题分析">2. 问题分析<a hidden class="anchor" aria-hidden="true" href="#2-问题分析">#</a></h2>
<p>查看异常堆栈信息，执行路径代码</p>
<p>org.springframework.data.redis.core.script.DefaultScriptExecutor#execute(org.springframework.data.redis.core.script.RedisScript<!-- raw HTML omitted -->, org.springframework.data.redis.serializer.RedisSerializer&lt;?&gt;, org.springframework.data.redis.serializer.RedisSerializer<!-- raw HTML omitted -->, java.util.List<!-- raw HTML omitted -->, java.lang.Object&hellip;)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">	<span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> T <span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> RedisScript<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> script<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> RedisSerializer<span style="color:#f92672">&lt;?&gt;</span> argsSerializer<span style="color:#f92672">,</span>
			<span style="color:#66d9ef">final</span> RedisSerializer<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> resultSerializer<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> List<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">&gt;</span> keys<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> Object<span style="color:#f92672">...</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		<span style="color:#66d9ef">return</span> template<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">((</span>RedisCallback<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;)</span> connection <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
			<span style="color:#66d9ef">final</span> ReturnType returnType <span style="color:#f92672">=</span> ReturnType<span style="color:#f92672">.</span><span style="color:#a6e22e">fromJavaType</span><span style="color:#f92672">(</span>script<span style="color:#f92672">.</span><span style="color:#a6e22e">getResultType</span><span style="color:#f92672">());</span>
			<span style="color:#66d9ef">final</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[][]</span> keysAndArgs <span style="color:#f92672">=</span> keysAndArgs<span style="color:#f92672">(</span>argsSerializer<span style="color:#f92672">,</span> keys<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
			<span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> keySize <span style="color:#f92672">=</span> keys <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> keys<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> 0<span style="color:#f92672">;</span>
			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>connection<span style="color:#f92672">.</span><span style="color:#a6e22e">isPipelined</span><span style="color:#f92672">()</span> <span style="color:#f92672">||</span> connection<span style="color:#f92672">.</span><span style="color:#a6e22e">isQueueing</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
				<span style="color:#75715e">// We could script load first and then do evalsha to ensure sha is present,
</span><span style="color:#75715e"></span>				<span style="color:#75715e">// but this adds a sha1 to exec/closePipeline results. Instead, just eval
</span><span style="color:#75715e"></span>				connection<span style="color:#f92672">.</span><span style="color:#a6e22e">eval</span><span style="color:#f92672">(</span>scriptBytes<span style="color:#f92672">(</span>script<span style="color:#f92672">),</span> returnType<span style="color:#f92672">,</span> keySize<span style="color:#f92672">,</span> keysAndArgs<span style="color:#f92672">);</span>
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
			<span style="color:#f92672">}</span>
			<span style="color:#66d9ef">return</span> eval<span style="color:#f92672">(</span>connection<span style="color:#f92672">,</span> script<span style="color:#f92672">,</span> returnType<span style="color:#f92672">,</span> keySize<span style="color:#f92672">,</span> keysAndArgs<span style="color:#f92672">,</span> resultSerializer<span style="color:#f92672">);</span>
		<span style="color:#f92672">});</span>
	<span style="color:#f92672">}</span>
</code></pre></div><p>org.springframework.data.redis.connection.ReturnType#fromJavaType</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e">	 * @param javaType can be {@literal null} which translates to {@link ReturnType#STATUS}.
</span><span style="color:#75715e">	 * @return never {@literal null}.
</span><span style="color:#75715e">	 */</span>
	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> ReturnType <span style="color:#a6e22e">fromJavaType</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@Nullable</span> Class<span style="color:#f92672">&lt;?&gt;</span> javaType<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>javaType <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
			<span style="color:#66d9ef">return</span> ReturnType<span style="color:#f92672">.</span><span style="color:#a6e22e">STATUS</span><span style="color:#f92672">;</span>
		<span style="color:#f92672">}</span>
		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>javaType<span style="color:#f92672">.</span><span style="color:#a6e22e">isAssignableFrom</span><span style="color:#f92672">(</span>List<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
			<span style="color:#66d9ef">return</span> ReturnType<span style="color:#f92672">.</span><span style="color:#a6e22e">MULTI</span><span style="color:#f92672">;</span>
		<span style="color:#f92672">}</span>
		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>javaType<span style="color:#f92672">.</span><span style="color:#a6e22e">isAssignableFrom</span><span style="color:#f92672">(</span>Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
			<span style="color:#66d9ef">return</span> ReturnType<span style="color:#f92672">.</span><span style="color:#a6e22e">BOOLEAN</span><span style="color:#f92672">;</span>
		<span style="color:#f92672">}</span>
		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>javaType<span style="color:#f92672">.</span><span style="color:#a6e22e">isAssignableFrom</span><span style="color:#f92672">(</span>Long<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
			<span style="color:#66d9ef">return</span> ReturnType<span style="color:#f92672">.</span><span style="color:#a6e22e">INTEGER</span><span style="color:#f92672">;</span>
		<span style="color:#f92672">}</span>
		<span style="color:#66d9ef">return</span> ReturnType<span style="color:#f92672">.</span><span style="color:#a6e22e">VALUE</span><span style="color:#f92672">;</span>
	<span style="color:#f92672">}</span>
</code></pre></div><p>有上面这个方法可以看出，如果传入的javaType为null，则ReturnType为STAUTS，如果是Long，则返回INTEGER</p>
<p>org.springframework.data.redis.connection.lettuce.LettuceScriptingCommands#eval</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">	<span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> T <span style="color:#a6e22e">eval</span><span style="color:#f92672">(</span><span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> script<span style="color:#f92672">,</span> ReturnType returnType<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> numKeys<span style="color:#f92672">,</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]...</span> keysAndArgs<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

		Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">notNull</span><span style="color:#f92672">(</span>script<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Script must not be null!&#34;</span><span style="color:#f92672">);</span>

		<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
			<span style="color:#66d9ef">byte</span><span style="color:#f92672">[][]</span> keys <span style="color:#f92672">=</span> extractScriptKeys<span style="color:#f92672">(</span>numKeys<span style="color:#f92672">,</span> keysAndArgs<span style="color:#f92672">);</span>
			<span style="color:#66d9ef">byte</span><span style="color:#f92672">[][]</span> args <span style="color:#f92672">=</span> extractScriptArgs<span style="color:#f92672">(</span>numKeys<span style="color:#f92672">,</span> keysAndArgs<span style="color:#f92672">);</span>
			String convertedScript <span style="color:#f92672">=</span> LettuceConverters<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(</span>script<span style="color:#f92672">);</span>
			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isPipelined<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
				pipeline<span style="color:#f92672">(</span>connection<span style="color:#f92672">.</span><span style="color:#a6e22e">newLettuceResult</span><span style="color:#f92672">(</span>
						getAsyncConnection<span style="color:#f92672">().</span><span style="color:#a6e22e">eval</span><span style="color:#f92672">(</span>convertedScript<span style="color:#f92672">,</span> LettuceConverters<span style="color:#f92672">.</span><span style="color:#a6e22e">toScriptOutputType</span><span style="color:#f92672">(</span>returnType<span style="color:#f92672">),</span> keys<span style="color:#f92672">,</span> args<span style="color:#f92672">),</span>
						<span style="color:#66d9ef">new</span> LettuceEvalResultsConverter<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;(</span>returnType<span style="color:#f92672">)));</span>
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
			<span style="color:#f92672">}</span>
			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isQueueing<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
				transaction<span style="color:#f92672">(</span>connection<span style="color:#f92672">.</span><span style="color:#a6e22e">newLettuceResult</span><span style="color:#f92672">(</span>
						getAsyncConnection<span style="color:#f92672">().</span><span style="color:#a6e22e">eval</span><span style="color:#f92672">(</span>convertedScript<span style="color:#f92672">,</span> LettuceConverters<span style="color:#f92672">.</span><span style="color:#a6e22e">toScriptOutputType</span><span style="color:#f92672">(</span>returnType<span style="color:#f92672">),</span> keys<span style="color:#f92672">,</span> args<span style="color:#f92672">),</span>
						<span style="color:#66d9ef">new</span> LettuceEvalResultsConverter<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;(</span>returnType<span style="color:#f92672">)));</span>
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
			<span style="color:#f92672">}</span>
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> LettuceEvalResultsConverter<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;(</span>returnType<span style="color:#f92672">)</span>
					<span style="color:#f92672">.</span><span style="color:#a6e22e">convert</span><span style="color:#f92672">(</span>getConnection<span style="color:#f92672">().</span><span style="color:#a6e22e">eval</span><span style="color:#f92672">(</span>convertedScript<span style="color:#f92672">,</span> LettuceConverters<span style="color:#f92672">.</span><span style="color:#a6e22e">toScriptOutputType</span><span style="color:#f92672">(</span>returnType<span style="color:#f92672">),</span> keys<span style="color:#f92672">,</span> args<span style="color:#f92672">));</span>
		<span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
			<span style="color:#66d9ef">throw</span> convertLettuceAccessException<span style="color:#f92672">(</span>ex<span style="color:#f92672">);</span>
		<span style="color:#f92672">}</span>
	<span style="color:#f92672">}</span>
</code></pre></div><p>底层使用异步的命令方式</p>
<p>io.lettuce.core.AbstractRedisAsyncCommands#eval(java.lang.String, io.lettuce.core.ScriptOutputType, K[], V&hellip;)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> RedisFuture<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">eval</span><span style="color:#f92672">(</span>String script<span style="color:#f92672">,</span> ScriptOutputType type<span style="color:#f92672">,</span> K<span style="color:#f92672">[]</span> keys<span style="color:#f92672">,</span> V<span style="color:#f92672">...</span> values<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>RedisFuture<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;)</span> dispatch<span style="color:#f92672">(</span>commandBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">eval</span><span style="color:#f92672">(</span>script<span style="color:#f92672">,</span> type<span style="color:#f92672">,</span> keys<span style="color:#f92672">,</span> values<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>io.lettuce.core.RedisCommandBuilder#eval(java.lang.String, io.lettuce.core.ScriptOutputType, K&hellip;)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> Command<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">,</span> T<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">eval</span><span style="color:#f92672">(</span>String script<span style="color:#f92672">,</span> ScriptOutputType type<span style="color:#f92672">,</span> K<span style="color:#f92672">...</span> keys<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        LettuceAssert<span style="color:#f92672">.</span><span style="color:#a6e22e">notNull</span><span style="color:#f92672">(</span>script<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Script &#34;</span> <span style="color:#f92672">+</span> MUST_NOT_BE_NULL<span style="color:#f92672">);</span>
        LettuceAssert<span style="color:#f92672">.</span><span style="color:#a6e22e">notEmpty</span><span style="color:#f92672">(</span>script<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Script &#34;</span> <span style="color:#f92672">+</span> MUST_NOT_BE_EMPTY<span style="color:#f92672">);</span>
        LettuceAssert<span style="color:#f92672">.</span><span style="color:#a6e22e">notNull</span><span style="color:#f92672">(</span>type<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;ScriptOutputType &#34;</span> <span style="color:#f92672">+</span> MUST_NOT_BE_NULL<span style="color:#f92672">);</span>
        LettuceAssert<span style="color:#f92672">.</span><span style="color:#a6e22e">notNull</span><span style="color:#f92672">(</span>keys<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Keys &#34;</span> <span style="color:#f92672">+</span> MUST_NOT_BE_NULL<span style="color:#f92672">);</span>

        CommandArgs<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> args <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> CommandArgs<span style="color:#f92672">&lt;&gt;(</span>codec<span style="color:#f92672">);</span>
        args<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>script<span style="color:#f92672">.</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>keys<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">).</span><span style="color:#a6e22e">addKeys</span><span style="color:#f92672">(</span>keys<span style="color:#f92672">);</span>
        CommandOutput<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">,</span> T<span style="color:#f92672">&gt;</span> output <span style="color:#f92672">=</span> newScriptOutput<span style="color:#f92672">(</span>codec<span style="color:#f92672">,</span> type<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> createCommand<span style="color:#f92672">(</span>EVAL<span style="color:#f92672">,</span> output<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>从上面可以看到CommandOutput的构造</p>
<p>CommandOutput&lt;K, V, T&gt; output = newScriptOutput(codec, type);</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> CommandOutput<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">,</span> T<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">newScriptOutput</span><span style="color:#f92672">(</span>RedisCodec<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> codec<span style="color:#f92672">,</span> ScriptOutputType type<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>type<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">case</span> BOOLEAN<span style="color:#f92672">:</span>
                <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>CommandOutput<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">,</span> T<span style="color:#f92672">&gt;)</span> <span style="color:#66d9ef">new</span> BooleanOutput<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;(</span>codec<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">case</span> INTEGER<span style="color:#f92672">:</span>
                <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>CommandOutput<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">,</span> T<span style="color:#f92672">&gt;)</span> <span style="color:#66d9ef">new</span> IntegerOutput<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;(</span>codec<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">case</span> STATUS<span style="color:#f92672">:</span>
                <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>CommandOutput<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">,</span> T<span style="color:#f92672">&gt;)</span> <span style="color:#66d9ef">new</span> StatusOutput<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;(</span>codec<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">case</span> MULTI<span style="color:#f92672">:</span>
                <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>CommandOutput<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">,</span> T<span style="color:#f92672">&gt;)</span> <span style="color:#66d9ef">new</span> NestedMultiOutput<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;(</span>codec<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">case</span> VALUE<span style="color:#f92672">:</span>
                <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>CommandOutput<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">,</span> T<span style="color:#f92672">&gt;)</span> <span style="color:#66d9ef">new</span> ValueOutput<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;(</span>codec<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RedisException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Unsupported script output type&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>STATUS时，返回<em><strong>StatusOutput对象</strong></em></p>
<p>看一下下面的异常信息</p>
<pre><code>Caused by: java.lang.IllegalStateException
	at io.lettuce.core.output.CommandOutput.set(CommandOutput.java:85)
	at io.lettuce.core.protocol.RedisStateMachine.safeSet(RedisStateMachine.java:357)
	at io.lettuce.core.protocol.RedisStateMachine.decode(RedisStateMachine.java:138)
</code></pre><p>CommandOutput是个抽象类, set方法抛出异常</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">set</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> integer<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalStateException<span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>而StatusOutput对象是CommandOutput的实现类单并没有实现set方法，因此抛出了异常。</p>
<h2 id="3-问题解决">3. 问题解决<a hidden class="anchor" aria-hidden="true" href="#3-问题解决">#</a></h2>
<p>从上面的分析得出，应该使用IntegerOutput实现类，这个实现类对应的returnType是Long类型。所以应该对RedisScript设置resultType为Long.class.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">unlock</span><span style="color:#f92672">(</span>String uniqueId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">(</span>uniqueId<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    DefaultRedisScript<span style="color:#f92672">&lt;</span>Long<span style="color:#f92672">&gt;</span> script <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> DefaultRedisScript<span style="color:#f92672">&lt;&gt;(</span>RELEASE_LOCK_LUA_SCRIPT<span style="color:#f92672">,</span> Long<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
    Long result <span style="color:#f92672">=</span> redisTemplate<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span>script<span style="color:#f92672">,</span> Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">singletonList</span><span style="color:#f92672">(</span>getLockKey<span style="color:#f92672">(</span>lockKey<span style="color:#f92672">)),</span> uniqueId<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Objects<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>result<span style="color:#f92672">,</span> RELEASE_LOCK_SUCCESS_RESULT<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
</code></pre></div><p>至此，问题解决~</p>

</div>
  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://jiayanju.github.io/tags/redis/">Redis</a></li>
    </ul>
  </footer>
</article>
    </main><footer class="footer">
    <span>&copy; 2021 <a href="https://jiayanju.github.io">南极阳光</a></span>
    <span>&middot;</span>
    <span>Powered by <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a></span>
    <span>&middot;</span>
    <span>Theme <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>



<script>
    window.onload = function () {
        if (localStorage.getItem("menu-scroll-position")) {
            document.getElementById('menu').scrollLeft = localStorage.getItem("menu-scroll-position");
        }
    }
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

    function menu_on_scroll() {
        localStorage.setItem("menu-scroll-position", document.getElementById('menu').scrollLeft);
    }

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

</body>

</html>
